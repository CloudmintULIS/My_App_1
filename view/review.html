<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>√în t·∫≠p t·ª´ v·ª±ng</title>
<style>
    body {
        font-family: 'Segoe UI', sans-serif;
        background: #fdf6e3;
        margin: 0;
        padding: 40px;
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    h1 { margin-bottom: 30px; color: #333; text-align: center; }
    .flashcard-container {
        display: flex; align-items: center; justify-content: center; gap: 20px;
    }
    .nav-btn {
        background: none; border: none; font-size: 40px; cursor: pointer;
        color: #4CAF50; transition: transform 0.2s ease;
    }
    .nav-btn:hover { transform: scale(1.2); color: #388e3c; }
    .notebook {
        background: #fffdf5; border: 2px dashed #bbb; border-radius: 25px;
        padding: 25px; width: 360px; box-shadow: 4px 4px 20px rgba(0,0,0,0.15);
        position: relative;
    }
    .notebook::before {
        content:""; position:absolute; left:-12px; top:20px;
        width:10px; height:calc(100% - 40px);
        background: repeating-linear-gradient(#ccc, #ccc 4px, transparent 4px, transparent 8px);
    }
    .flashcard { display:flex; flex-direction:column; align-items:center; transition:opacity 0.4s ease; }
    .flashcard img {
        max-width:100%; max-height:200px; object-fit:contain;
        border-radius:10px; margin:auto;
    }
    .word { margin-top:15px; font-size:1.6em; font-weight:bold; color:#333; text-align:center; }
    .phonetic-container {
        margin-top:8px; font-size:1em; color:#555;
        display:flex; justify-content:center; align-items:center; gap:8px;
    }
    .audio-btn {
        background:none; border:none; cursor:pointer; font-size:1.2em;
    }
    .audio-btn:hover { color:#4CAF50; }
    .definition,.example { margin-top:8px; font-size:1em; color:#555; text-align:center; }
    .button-group {
        display:flex; gap:10px; margin-top:20px; width:100%; max-width:400px;
    }
    .button-group a,.button-group button {
        flex:1; text-align:center; padding:10px 0; border-radius:8px;
        font-size:16px; text-decoration:none; border:none; cursor:pointer;
        transition: background-color 0.3s ease;
    }
    .back-btn { background:#81c784; color:white; }
    .back-btn:hover { background:#66bb6a; }
    .quiz-btn { background:#ff9800; color:white; }
    .quiz-btn:hover { background:#e68900; }
    .delete-btn { background:#e74c3c; color:white; }
    .delete-btn:hover { background:#c0392b; }
    .micro-btn {
        font-size:1.2em; border:none; border-radius:50%;
        width:40px; height:40px; background:#fff; color:#333; cursor:pointer;
        display:flex; align-items:center; justify-content:center;
        transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
        box-shadow:0 2px 5px rgba(0,0,0,0.2);
    }
    .micro-btn:hover { transform:scale(1.1); }
    .micro-btn.recording {
        background:#2196F3; color:white; animation:pulse-btn 1.2s infinite;
    }
    @keyframes pulse-btn {
        0%{box-shadow:0 0 0 0 rgba(33,150,243,0.7);}
        70%{box-shadow:0 0 0 10px rgba(33,150,243,0);}
        100%{box-shadow:0 0 0 0 rgba(33,150,243,0);}
    }
    /* Popup d·ªãch nghƒ©a */
    .translate-popup {
        position: absolute;
        background: #fff;
        border: 1px solid #ccc;
        border-radius: 6px;
        padding: 6px 10px;
        font-size: 14px;
        color: #333;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        z-index: 9999;
        display: none;
        max-width: 200px;
        animation: fadeIn 0.2s ease-in-out;
    }
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-5px); }
        to { opacity: 1; transform: translateY(0); }
    }
    @media(max-width:600px){
        body{padding:15px;}
        .notebook{width:100%; padding:15px; margin:0 auto;}
        .flashcard img{width:100%; max-height:70vh;}
        .word{font-size:1.4em;}
        .nav-btn{font-size:30px;}
        .button-group{flex-direction:column;}
        .button-group a,.button-group button{width:100%;}
    }
</style>
</head>
<body>
<h1>üìñ Quy·ªÉn v·ªü t·ª´ v·ª±ng c·ªßa b·∫°n</h1>

{% if cards %}
<div class="flashcard-container">
    <button class="nav-btn" onclick="prevCard()">&#8592;</button>

    <div class="notebook">
        <div class="flashcard">
            <img class="flashcard-img" src="{{ cards[0].image_path }}" alt="Flashcard Image">
            <div class="word">{{ cards[0].word }}</div>

            <!-- Phi√™n √¢m + Loa + Mic -->
            <div class="phonetic-container">
                <span class="flashcard-phonetic">{{ cards[0].phonetic or '' }}</span>
                <button class="audio-btn" onclick="playAudio()" title="Nghe ph√°t √¢m">üîä</button>
                <audio class="flashcard-audio" src="{{ cards[0].audio or '' }}"></audio>
                <button class="micro-btn pronounce-btn" title="Nh·∫•n v√† n√≥i">üé§</button>
            </div>

            <div class="highlight-result"></div>
            <div class="definition">
                {% if cards[0].definition %}<strong>Def:</strong> {{ cards[0].definition }}{% endif %}
            </div>
            <div class="example">
                {% if cards[0].example %}<strong>Ex:</strong> {{ cards[0].example }}{% endif %}
            </div>
        </div>
    </div>

    <button class="nav-btn" onclick="nextCard()">&#8594;</button>
</div>

<div class="button-group">
    <a class="back-btn" href="{{ url_for('main.index') }}">üè† Trang ch√≠nh</a>
    <a class="quiz-btn" href="{{ url_for('quiz.quiz') }}">üéÆ Ch∆°i Quiz</a>
    <button class="delete-btn" onclick="deleteCard(currentIndex)">üóë X√≥a</button>
</div>
{% else %}
<p style="text-align:center; font-size:18px; margin-top:30px;">üòï B·∫°n ch∆∞a c√≥ t·ª´ v·ª±ng n√†o ƒë·ªÉ √¥n t·∫≠p.</p>
<a class="back-btn" href="{{ url_for('main.index') }}">üè† Trang ch√≠nh</a>
{% endif %}

<!-- popup -->
<div class="translate-popup"></div>

<script>
const cards = {{ cards|tojson }};
let currentIndex = 0;

const flashcardDiv = document.querySelector(".flashcard");
const flashcardImg = document.querySelector(".flashcard-img");
const flashcardWord = document.querySelector(".word");
const phoneticSpan = document.querySelector(".flashcard-phonetic");
const audioElem = document.querySelector(".flashcard-audio");
const audioBtn = document.querySelector(".audio-btn");
const highlightDiv = document.querySelector(".highlight-result");
const popup = document.querySelector(".translate-popup");

function showCard(index){
    flashcardDiv.style.opacity = 0;
    setTimeout(() => {
        const card = cards[index];
        flashcardImg.src = card.image_path;
        flashcardWord.textContent = card.word;
        phoneticSpan.textContent = card.phonetic || "";

        // Audio
        if(card.audio){
            audioElem.src = card.audio;
            audioBtn.style.display = "inline-block";
        } else {
            audioElem.src = "";
            audioBtn.style.display = "none";
        }

        highlightDiv.innerHTML = "";
        document.querySelector(".definition").innerHTML =
            card.definition ? `<strong>Def:</strong> ${card.definition}` : "";
        document.querySelector(".example").innerHTML =
            card.example ? `<strong>Ex:</strong> ${card.example}` : "";

        flashcardDiv.style.opacity = 1;
    }, 200);
}
function playAudio(){ if(audioElem && audioElem.src) audioElem.play(); }
function nextCard(){ currentIndex=(currentIndex+1)%cards.length; showCard(currentIndex); }
function prevCard(){ currentIndex=(currentIndex-1+cards.length)%cards.length; showCard(currentIndex); }

function deleteCard(index){
    if(!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a t·ª´ n√†y?")) return;
    const cardId = cards[index].id;
    fetch("/review/api/delete_card",{
        method:"POST", headers:{"Content-Type":"application/json"},
        body:JSON.stringify({card_id:cardId})
    })
    .then(res=>res.json())
    .then(data=>{
        if(data.success){
            cards.splice(index,1);
            if(cards.length===0){
                flashcardDiv.style.display="none";
                document.querySelector(".delete-btn").style.display="none";
                return;
            }
            if(currentIndex>=cards.length) currentIndex=0;
            showCard(currentIndex);
        }else alert("L·ªói: "+data.error);
    })
    .catch(err=>console.error(err));
}

// Swipe ch·ªâ cho ·∫£nh
let startX = 0, isDragging = false;
flashcardImg.addEventListener('touchstart', e => {
    startX = e.touches[0].clientX;
    isDragging = true;
});
flashcardImg.addEventListener('touchmove', e => {
    if (!isDragging) return;
    const deltaX = e.touches[0].clientX - startX;
    if (deltaX > 80) { prevCard(); isDragging = false; }
    else if (deltaX < -80) { nextCard(); isDragging = false; }
});
flashcardImg.addEventListener('touchend', () => { isDragging = false; });

flashcardImg.addEventListener('mousedown', e => {
    startX = e.clientX;
    isDragging = true;
});
flashcardImg.addEventListener('mousemove', e => {
    if (!isDragging) return;
    const deltaX = e.clientX - startX;
    if (deltaX > 80) { prevCard(); isDragging = false; }
    else if (deltaX < -80) { nextCard(); isDragging = false; }
});
flashcardImg.addEventListener('mouseup', () => { isDragging = false; });
flashcardImg.addEventListener('mouseleave', () => { isDragging = false; });

// --- N√∫t n√≥i & highlight ---
let mediaRecorder, audioChunks = [];
const pronounceBtn = document.querySelector(".pronounce-btn");

pronounceBtn.onclick = async () => {
    audioChunks = [];

    // L·∫•y audio stream t·ª´ micro
    let stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRecorder = new MediaRecorder(stream);
    mediaRecorder.start();

    // Disable n√∫t & ƒë·ªïi tr·∫°ng th√°i khi ƒëang ghi √¢m
    pronounceBtn.disabled = true;
    pronounceBtn.classList.add('recording');

    // Thu th·∫≠p d·ªØ li·ªáu audio
    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);

    // Khi stop th√¨ g·ª≠i audio l√™n server
    mediaRecorder.onstop = async () => {
        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
        const formData = new FormData();
        formData.append('audio', audioBlob);
        formData.append('word', cards[currentIndex].word);

        try {
            const res = await fetch("/review/api/check_pronounce", {
                method: "POST",
                body: formData
            });
            const data = await res.json();

            if (data.highlight) {
                // ‚úÖ C·∫≠p nh·∫≠t highlight l√™n t·ª´ g·ªëc
                flashcardWord.innerHTML = data.highlight;

                // ‚ùå T·∫°m comment ch·ªó hi·ªÉn th·ªã transcript b√™n d∆∞·ªõi
                // highlightDiv.innerHTML = `<em>Transcript nh·∫≠n di·ªán:</em> ${data.transcript}`;
            } else {
                // N·∫øu l·ªói th√¨ hi·ªán t·ª´ g·ªëc b√¨nh th∆∞·ªùng
                flashcardWord.textContent = cards[currentIndex].word;
                highlightDiv.textContent = data.result || "L·ªói khi ch·∫•m ph√°t √¢m";
            }

        } catch (err) {
            console.error(err);
            flashcardWord.textContent = cards[currentIndex].word;
            highlightDiv.textContent = "L·ªói khi g·ªçi API";
        }

        // --- Reset tr·∫°ng th√°i n√∫t ---
        pronounceBtn.disabled = false;
        pronounceBtn.classList.remove('recording'); // b·ªè vi·ªÅn xanh khi xong
    };

    // D·ª´ng sau 3s
    setTimeout(() => mediaRecorder.stop(), 3000);
};

// --- Popup d·ªãch nghƒ©a ---
document.addEventListener("mouseup", async () => {
    let selected = window.getSelection().toString().trim();
    if(selected){
        try {
            const res = await fetch("/api/translate", {
                method: "POST",
                headers: {"Content-Type":"application/json"},
                body: JSON.stringify({ text: selected })
            });
            const data = await res.json();
            if(data.translation){
                const rect = window.getSelection().getRangeAt(0).getBoundingClientRect();
                popup.style.left = `${rect.left + window.scrollX}px`;
                popup.style.top = `${rect.top + window.scrollY - 40}px`;
                popup.innerHTML = `<strong>${selected}</strong> ‚Üí ${data.translation}`;
                popup.style.display = "block";
            }
        } catch(err){
            console.error("Translate error:", err);
        }
    } else {
        popup.style.display = "none";
    }
});

// ·∫®n popup khi click ra ngo√†i
document.addEventListener("click", (e) => {
    if(!popup.contains(e.target)){
        popup.style.display = "none";
    }
});
</script>
</body>
</html>
